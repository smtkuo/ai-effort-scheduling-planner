<!DOCTYPE html>
<html lang="en" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Effort Planning System</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#2563eb',
                        'custom-indigo': '#4f46e5',
                    }
                }
            }
        }
    </script>
    <style>
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            @apply shadow-lg hover:shadow-xl transition-all duration-200;
        }
        .input:focus, .select:focus, .textarea:focus {
            @apply border-primary shadow-sm;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-base-200 to-base-300">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-4 sm:mb-8">
            <h1 class="text-2xl sm:text-4xl font-bold text-primary mb-2">AI Effort Planning System</h1>
            <p class="text-base sm:text-lg text-base-content/70">Intelligent Project Planning & Cost Estimation</p>
        </header>

        <!-- Main Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <!-- Project Details Section -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl border border-base-200">
                <div class="card-body p-4 sm:p-6">
                    <h2 class="card-title text-xl sm:text-2xl mb-4">Project Details</h2>
                    
                    <!-- Language Selection -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Project Language</span>
                            <span class="label-text-alt text-base-content/70">Select project language</span>
                        </label>
                        <select id="projectLanguage" class="select select-bordered w-full" onchange="updateLanguage()">
                            <option value="en">English (EN)</option>
                            <option value="tr">Türkçe (TR)</option>
                            <option value="de">Deutsch (DE)</option>
                            <option value="es">Español (ES)</option>
                            <option value="fr">Français (FR)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Project Description</span>
                        </label>
                        <textarea id="projectDescription" class="textarea textarea-bordered h-24 sm:h-32 text-sm sm:text-base" placeholder="Enter detailed project description"></textarea>
                    </div>

                    <!-- Add Daily Maximum Working Hours Input -->
                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Daily Maximum Working Hours</span>
                        </label>
                        <input 
                            type="number" 
                            id="maxDailyHours" 
                            class="input input-bordered" 
                            placeholder="8" 
                            min="1" 
                            max="24" 
                            value="${decodedData?.maxDailyHours || '8'}" 
                            oninput="updateUrlHash()"
                        >
                        <label class="label">
                            <span class="label-text-alt">Maximum hours a team member can work per day</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- API Configuration -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl border border-base-200">
                <div class="card-body p-4 sm:p-6">
                    <h2 class="card-title text-xl sm:text-2xl mb-4">API Configuration</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">RapidAPI Key</span>
                        </label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="apiKey" class="input input-bordered flex-1 text-sm sm:text-base" placeholder="Enter your RapidAPI key">
                            <button class="btn btn-primary w-full sm:w-auto" onclick="window.location.href='https://rapidapi.com/bilgisamapi-api2/api/generative-ai-api-openai-gpt-4o-api-ai-integration'">
                                Get Key
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Members Section -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl border border-base-200">
                <div class="card-body p-4 sm:p-6">
                    <h2 class="card-title text-xl sm:text-2xl mb-4">Team Members</h2>
                    <div id="teamMembers" class="space-y-2">
                        <!-- Team member entries will be added here -->
                    </div>
                    <button class="btn btn-primary btn-lg gap-2 mt-6 w-full sm:w-auto" onclick="addTeamMember()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add Team Member
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl border border-base-200">
                <div class="card-body p-4 sm:p-6">
                    <h2 class="card-title text-xl sm:text-2xl mb-4">Planning Results</h2>
                    <div id="results" class="prose max-w-full">
                        <!-- Results will be displayed here -->
                    </div>
                    <div class="divider my-4"></div>
                    <div class="flex flex-col gap-4">
                        <button class="btn btn-primary btn-lg w-full hover:scale-[1.02] transform transition-all duration-200 shadow-lg hover:shadow-xl" onclick="generatePlan()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Generate Plan
                        </button>
                        <div class="card bg-base-200 shadow-sm hover:shadow-md transition-all duration-300">
                            <div class="card-body p-6 items-center text-center">
                                <div class="w-full flex justify-center">
                                    <div id="qrcode" class="bg-white rounded-xl shadow-inner w-[320px] h-[320px] flex items-center justify-center overflow-hidden"></div>
                                </div>
                                <p class="text-sm text-base-content/70 mt-3">Scan to share configuration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add QR Code library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <script>
        // Initialize empty project plan at the top level
        window.projectPlanData = {
            timeline: {
                weeks: []
            }
        };

        // Update window.onload to show timeline immediately
        window.onload = function() {
            try {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const decodedData = JSON.parse(decodeURIComponent(hash));
                    if (decodedData.apiKey) {
                        document.getElementById('apiKey').value = decodedData.apiKey;
                    }
                    if (decodedData.projectDescription) {
                        document.getElementById('projectDescription').value = decodedData.projectDescription;
                    }
                    if (decodedData.projectLanguage) {
                        document.getElementById('projectLanguage').value = decodedData.projectLanguage;
                        document.documentElement.lang = decodedData.projectLanguage;
                    }
                    if (decodedData.teamMembers && Array.isArray(decodedData.teamMembers)) {
                        document.getElementById('teamMembers').innerHTML = '';
                        decodedData.teamMembers.forEach(member => {
                            addTeamMember(member);
                        });
                    } else {
                        addTeamMember();
                    }
                    // Load project plan data if exists
                    if (decodedData.projectPlan) {
                        window.projectPlanData = decodedData.projectPlan;
                    }
                } else {
                    addTeamMember();
                }
            } catch (error) {
                console.error('Error parsing URL data:', error);
                addTeamMember();
            }
            // Always display timeline, even if empty
            displayResults(window.projectPlanData);
        }

        function displayResults(plan) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="flex flex-col gap-6 w-full max-w-5xl mx-auto">
                    <!-- Project Timeline Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-base-200 p-4 rounded-xl shadow-lg">
                        <div class="flex items-center gap-3">
                            <div class="badge badge-primary p-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 class="text-lg sm:text-xl font-bold">Project Timeline</h3>
                        </div>
                        <button onclick="addNewWeek()" class="btn btn-primary w-full sm:w-auto gap-2 normal-case">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Add Week
                        </button>
                    </div>

                    <!-- Weeks Container -->
                    <div class="space-y-6 overflow-x-auto" id="weeksContainer">
                        ${generateWeeksHTML(plan)}
                    </div>
                </div>
            `;
        }

        function generateWeeksHTML(plan) {
            if (!plan || !plan.timeline || !plan.timeline.weeks || plan.timeline.weeks.length === 0) {
                return `
                    <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-all duration-300">
                        <div class="card-body items-center text-center py-12">
                            <div class="text-6xl mb-4">📅</div>
                            <h3 class="text-xl font-bold mb-2">Start Your Project Timeline</h3>
                            <p class="text-base-content/70 mb-6">Add your first week to begin planning your project</p>
                            <button onclick="addNewWeek()" class="btn btn-primary btn-lg gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add First Week
                            </button>
                        </div>
                    </div>`;
            }

            let totalCosts = {};
            const weeksHTML = plan.timeline.weeks.map((week, weekIndex) => {
                const weekCosts = calculateWeekCosts(week);
                
                // Add to total costs
                Object.entries(weekCosts).forEach(([currency, amount]) => {
                    if (!totalCosts[currency]) {
                        totalCosts[currency] = 0;
                    }
                    totalCosts[currency] += amount;
                });

                return `
                <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="card-body p-4">
                        <!-- Week Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="badge badge-primary badge-lg">${week.weekNumber}</div>
                                <h4 class="text-lg font-bold">Week ${week.weekNumber}</h4>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 items-end sm:items-center w-full sm:w-auto">
                                <!-- Week Cost Display -->
                                <div class="flex gap-2 items-center">
                                    <span class="text-sm opacity-70">Week Total:</span>
                                    <div class="font-mono text-sm">
                                        ${Object.entries(weekCosts).map(([currency, amount]) => `
                                            <span class="badge ${currency === 'USD' ? 'badge-ghost' : 'badge-primary'} badge-sm ml-1">
                                                ${formatCurrency(amount, currency)}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                <button onclick="deleteWeek(${weekIndex})" class="btn btn-error btn-sm gap-2 w-full sm:w-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete Week
                                </button>
                            </div>
                        </div>

                        <!-- Days Grid -->
                        <div class="grid grid-cols-1 gap-4">
                            ${week.days.map((day, dayIndex) => `
                                <div class="card bg-base-100 shadow hover:shadow-md transition-all duration-300">
                                    <div class="card-body p-4">
                                        <!-- Day Header -->
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="flex items-center gap-2">
                                                <div class="badge badge-primary">${dayIndex + 1}</div>
                                                <h5 class="font-semibold">Day ${dayIndex + 1}</h5>
                                            </div>
                                            <button onclick="addNewTask(${weekIndex}, ${dayIndex})" 
                                                class="btn btn-ghost btn-sm btn-square hover:bg-base-200">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                </svg>
                                            </button>
                                        </div>

                                        <!-- Tasks List -->
                                        <div class="space-y-3">
                                            ${(day.tasks || []).map((task, taskIndex) => `
                                                <div class="card bg-base-200 hover:bg-base-300 transition-colors duration-200">
                                                    <div class="card-body p-3">
                                                        <!-- Task Header -->
                                                        <div class="flex justify-between items-start gap-2">
                                                            <input type="text" 
                                                                class="input input-sm input-ghost w-full font-medium" 
                                                                value="${task.title || ''}"
                                                                onchange="updateTaskTitle('${task.id}', this.value)"
                                                                placeholder="Task title">
                                                            <button onclick="deleteTask(${weekIndex}, ${dayIndex}, ${taskIndex})" 
                                                                class="btn btn-ghost btn-sm btn-square text-error hover:bg-error/10">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>

                                                        <!-- Task Details -->
                                                        <div class="space-y-3 mt-2">
                                                            <textarea 
                                                                class="textarea textarea-bordered textarea-sm w-full bg-base-100" 
                                                                rows="2"
                                                                onchange="updateTaskDescription('${task.id}', this.value)"
                                                                placeholder="Task description">${task.description || ''}</textarea>

                                                            <div class="grid grid-cols-1 gap-2">
                                                                <select 
                                                                    class="select select-sm select-bordered w-full bg-base-100" 
                                                                    onchange="updateTaskAssignee('${task.id}', this.value)">
                                                                    <option value="">👤 Assign to</option>
                                                                    ${getTeamMemberOptions(task.assignedTo)}
                                                                </select>

                                                                <div class="join w-full">
                                                                    <input 
                                                                        type="number" 
                                                                        class="input input-sm input-bordered join-item w-full bg-base-100" 
                                                                        value="${task.estimatedHours || ''}"
                                                                        onchange="updateTaskHours('${task.id}', this.value)"
                                                                        placeholder="Hours">
                                                                    <span class="btn btn-sm join-item no-animation bg-base-100">h</span>
                                                                </div>
                                                            </div>

                                                            ${calculateAndDisplayCost(task)}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${day.tasks.length === 0 ? `
                                                <div class="text-center py-4 text-base-content/50">
                                                    <p class="text-sm">No tasks yet</p>
                                                    <button onclick="addNewTask(${weekIndex}, ${dayIndex})" 
                                                        class="btn btn-ghost btn-sm mt-2">
                                                        Add Task
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Add total costs section
            const totalCostsHTML = `
                <div class="card bg-primary text-primary-content shadow-lg hover:shadow-xl transition-all duration-300 mt-6">
                    <div class="card-body p-4">
                        <h3 class="card-title">Total Project Cost</h3>
                        <div class="flex flex-wrap gap-3 items-center">
                            ${Object.entries(totalCosts).map(([currency, amount]) => `
                                <div class="stat bg-primary-focus rounded-box p-3">
                                    <div class="stat-title text-primary-content/70">Total in ${currency}</div>
                                    <div class="stat-value text-2xl">${formatCurrency(amount, currency)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            return weeksHTML + totalCostsHTML;
        }

        function calculateAndDisplayCost(task) {
            if (!task.assignedTo || !task.estimatedHours) {
                task.cost = null;
                return '';
            }

            const teamMember = findTeamMember(task.assignedTo);
            if (!teamMember) {
                task.cost = null;
                return '';
            }

            const rate = parseFloat(teamMember.rate) || 0;
            const hours = parseFloat(task.estimatedHours) || 0;
            const cost = parseFloat((rate * hours).toFixed(2));
            const usdCost = parseFloat(convertToUSD(cost, teamMember.currency).toFixed(2));

            // Save cost information in task object
            task.cost = {
                original: { 
                    amount: cost,
                    currency: teamMember.currency
                },
                usd: { 
                    amount: usdCost,
                    currency: 'USD'
                },
                hourlyRate: rate,
                hours: hours
            };

            return `
                <div class="mt-3 flex justify-between items-center">
                    <span class="badge badge-ghost gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Task Cost (${hours}h × ${formatCurrency(rate, teamMember.currency)}/h)
                    </span>
                    <div class="font-mono text-sm">
                        <span class="badge badge-primary badge-sm">
                            ${formatCurrency(cost, teamMember.currency)}
                        </span>
                        ${teamMember.currency !== 'USD' ? `
                            <span class="badge badge-ghost badge-sm ml-1">
                                ${formatCurrency(usdCost, 'USD')}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function calculateDayCosts(day) {
            let dayCosts = {};
            
            (day.tasks || []).forEach(task => {
                if (task.cost) {
                    const currency = task.cost.original.currency;
                    const cost = task.cost.original.amount;
                    const usdCost = task.cost.usd.amount;

                    // Sum original currency costs
                    if (!dayCosts[currency]) {
                        dayCosts[currency] = 0;
                    }
                    dayCosts[currency] = parseFloat((dayCosts[currency] + cost).toFixed(2));

                    // Sum USD costs if different currency
                    if (currency !== 'USD') {
                        if (!dayCosts['USD']) {
                            dayCosts['USD'] = 0;
                        }
                        dayCosts['USD'] = parseFloat((dayCosts['USD'] + usdCost).toFixed(2));
                    }
                }
            });

            return dayCosts;
        }

        function calculateWeekCosts(week) {
            let weekCosts = {};
            
            week.days.forEach(day => {
                const dayCosts = calculateDayCosts(day);
                Object.entries(dayCosts).forEach(([currency, amount]) => {
                    if (!weekCosts[currency]) {
                        weekCosts[currency] = 0;
                    }
                    weekCosts[currency] = parseFloat((weekCosts[currency] + amount).toFixed(2));
                });
            });

            return weekCosts;
        }

        function generateDayHTML(day, weekIndex, dayIndex) {
            const dayCosts = calculateDayCosts(day);
            
            return `
                <div class="card bg-base-100 shadow hover:shadow-md transition-all duration-300">
                    <div class="card-body p-4">
                        <!-- Day Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <div class="badge badge-primary">${dayIndex + 1}</div>
                                <h5 class="font-semibold">Day ${dayIndex + 1}</h5>
                            </div>
                            <div class="flex gap-2 items-center">
                                <span class="text-sm opacity-70">Day Total:</span>
                                <div class="font-mono text-sm">
                                    ${Object.entries(dayCosts).map(([currency, amount]) => `
                                        <span class="badge ${currency === 'USD' ? 'badge-ghost' : 'badge-primary'} badge-sm ml-1">
                                            ${formatCurrency(amount, currency)}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <button onclick="addNewTask(${weekIndex}, ${dayIndex})" 
                                class="btn btn-ghost btn-sm btn-square hover:bg-base-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </button>
                        </div>

                        <!-- Tasks List -->
                        <div class="space-y-3">
                            ${(day.tasks || []).map((task, taskIndex) => `
                                <div class="card bg-base-200 hover:bg-base-300 transition-colors duration-200">
                                    <div class="card-body p-3">
                                        <!-- Task Header -->
                                        <div class="flex justify-between items-start gap-2">
                                            <input type="text" 
                                                class="input input-sm input-ghost w-full font-medium" 
                                                value="${task.title || ''}"
                                                onchange="updateTaskTitle('${task.id}', this.value)"
                                                placeholder="Task title">
                                            <button onclick="deleteTask(${weekIndex}, ${dayIndex}, ${taskIndex})" 
                                                class="btn btn-ghost btn-sm btn-square text-error hover:bg-error/10">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>

                                                        <!-- Task Details -->
                                                        <div class="space-y-3 mt-2">
                                                            <textarea 
                                                                class="textarea textarea-bordered textarea-sm w-full bg-base-100" 
                                                                rows="2"
                                                                onchange="updateTaskDescription('${task.id}', this.value)"
                                                                placeholder="Task description">${task.description || ''}</textarea>

                                                            <div class="grid grid-cols-1 gap-2">
                                                                <select 
                                                                    class="select select-sm select-bordered w-full bg-base-100" 
                                                                    onchange="updateTaskAssignee('${task.id}', this.value)">
                                                                    <option value="">👤 Assign to</option>
                                                                    ${getTeamMemberOptions(task.assignedTo)}
                                                                </select>

                                                                <div class="join w-full">
                                                                    <input 
                                                                        type="number" 
                                                                        class="input input-sm input-bordered join-item w-full bg-base-100" 
                                                                        value="${task.estimatedHours || ''}"
                                                                        onchange="updateTaskHours('${task.id}', this.value)"
                                                                        placeholder="Hours">
                                                                    <span class="btn btn-sm join-item no-animation bg-base-100">h</span>
                                                                </div>
                                                            </div>

                                                            ${calculateAndDisplayCost(task)}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${day.tasks.length === 0 ? `
                                                <div class="text-center py-4 text-base-content/50">
                                                    <p class="text-sm">No tasks yet</p>
                                                    <button onclick="addNewTask(${weekIndex}, ${dayIndex})" 
                                                        class="btn btn-ghost btn-sm mt-2">
                                                        Add Task
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function findTeamMember(name) {
            const memberCard = Array.from(document.querySelectorAll('#teamMembers .card'))
                .find(card => card.querySelector('input[placeholder="Team Member Name"]').value === name);
            
            if (memberCard) {
                return {
                    rate: memberCard.querySelector('input[placeholder="0.00"]').value,
                    currency: memberCard.querySelector('select').value
                };
            }
            return null;
        }

        // Team member management
        function addTeamMember(memberData = null) {
            const teamMembersDiv = document.getElementById('teamMembers');
            const memberDiv = document.createElement('div');
            memberDiv.className = 'card bg-base-100 shadow-sm hover:shadow-xl transition-all duration-300 border border-base-200';
            memberDiv.innerHTML = `
                <div class="card-body p-6 bg-gradient-to-r from-base-100 to-base-50">
                    <div class="flex justify-between items-start">
                        <div class="form-control w-full">
                            <input type="text" 
                                class="input input-lg input-ghost w-full text-xl font-semibold focus:input-ghost border-0 focus:bg-base-100" 
                                placeholder="Team Member Name" 
                                value="${memberData?.name || ''}" 
                                oninput="updateUrlHash()"
                            >
                        </div>
                        <button class="btn btn-circle btn-sm btn-ghost text-error hover:bg-error/10" 
                            onclick="this.closest('.card').remove(); updateUrlHash()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 mt-4">
                        <!-- Hourly Rate Section -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium text-base-content/80">Hourly Rate</span>
                            </label>
                            <div class="join w-full shadow-sm">
                                <select class="select select-bordered join-item w-24 bg-base-100 hover:bg-base-200" onchange="updateUrlHash()">
                                    <option value="USD" ${memberData?.currency === 'USD' ? 'selected' : ''}>$</option>
                                    <option value="EUR" ${memberData?.currency === 'EUR' ? 'selected' : ''}>€</option>
                                    <option value="GBP" ${memberData?.currency === 'GBP' ? 'selected' : ''}>£</option>
                                    <option value="TRY" ${memberData?.currency === 'TRY' ? 'selected' : ''}>₺</option>
                                </select>
                                <input type="number" 
                                    class="input input-bordered join-item w-full text-right pr-2 focus:z-10" 
                                    placeholder="0.00" 
                                    value="${memberData?.rate || ''}" 
                                    oninput="updateUrlHash()"
                                >
                            </div>
                            <label class="label">
                                <span class="label-text-alt text-success font-mono opacity-75"></span>
                            </label>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            const rateInput = memberDiv.querySelector('input[type="number"]:not([placeholder="0"])');
            const currencySelect = memberDiv.querySelector('select');
            const usdConversionSpan = memberDiv.querySelector('.label-text-alt.text-success');

            function updateUSDConversion() {
                const rate = parseFloat(rateInput.value) || 0;
                const currency = currencySelect.value;
                if (rate && currency !== 'USD') {
                    const usdRate = convertToUSD(rate, currency);
                    usdConversionSpan.textContent = `≈ ${formatCurrency(usdRate, 'USD')}/hour`;
                } else {
                    usdConversionSpan.textContent = '';
                }
            }

            rateInput.addEventListener('input', updateUSDConversion);
            currencySelect.addEventListener('change', updateUSDConversion);

            // Initial update
            updateUSDConversion();

            addTeamMemberChangeListener(memberDiv);
            teamMembersDiv.appendChild(memberDiv);
            
            // Update all task assignee dropdowns
            document.querySelectorAll('select[onchange^="updateTaskAssignee"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = getTeamMemberOptions(currentValue);
            });
        }

        // Currency conversion rates (you should update these with real-time rates)
        const conversionRates = {
            USD: 1,
            EUR: 1/0.9709,
            GBP: 1/0.8124,
            TRY: 1/35.3269
        };

        // Currency symbols
        const currencySymbols = {
            USD: '$',
            EUR: '€',
            GBP: '£',
            TRY: '₺'
        };

        function convertToUSD(amount, fromCurrency) {
            if (fromCurrency === 'USD') return amount;
            
            const conversionRates = {
                'EUR': 1/0.9709,
                'GBP': 1/0.8124,
                'TRY': 1/35.3269
            };

            const rate = conversionRates[fromCurrency] || 1;
            return parseFloat((amount * rate).toFixed(2));
        }

        function formatCurrency(amount, currency) {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return formatter.format(amount);
        }

        // Generate plan function
        function generatePlan() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your RapidAPI key');
                return;
            }

            // Show loading state
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="mt-4 text-lg font-semibold text-primary/80">Analyzing and Generating Plan...</p>
                    <p class="mt-2 text-sm text-base-content/60">This may take up to 3 minutes...</p>
                </div>
            `;

            // Get team members with their rates and currencies
            const teamMembers = Array.from(document.querySelectorAll('#teamMembers .card')).map(card => ({
                name: card.querySelector('input[placeholder="Team Member Name"]').value,
                rate: parseFloat(card.querySelector('input[placeholder="0.00"]').value) || 0,
                currency: card.querySelector('select').value
            })).filter(member => member.name && member.rate > 0);

            if (teamMembers.length === 0) {
                alert('Please add at least one team member with a valid hourly rate');
                return;
            }

            const maxDailyHours = parseInt(document.getElementById('maxDailyHours').value) || 8;
            const projectDescription = document.getElementById('projectDescription').value;
            const projectLanguage = document.getElementById('projectLanguage').value;

            // Create team members string for prompt
            const teamMembersString = teamMembers.map(member => 
                `${member.name} (${currencySymbols[member.currency]}${member.rate}/hour in ${member.currency})`
            ).join(', ');

            const data = JSON.stringify({
                prompt: `Based on the following project information, create a detailed development plan with specific tasks:

Project Description: ${projectDescription}
Team Members: ${teamMembersString}
Daily Maximum Working Hours per Team Member: ${maxDailyHours} hours

Please analyze the project description and create a comprehensive task list following these guidelines:

1. Project Analysis & Planning Phase:
   - Analyze the project requirements from the description
   - Break down the main features and functionalities
   - Identify system architecture requirements
   - List all required technologies and tools
   - Define project scope and boundaries
   - Create database schema (if required)
   - Plan API endpoints (if required)
   - Define UI/UX requirements (if applicable)

2. Development Environment Setup:
   - Create detailed tasks for setting up:
     * Version control system
     * Development environment
     * Testing environment
     * Continuous Integration setup
     * Required frameworks and libraries
     * Database setup
     * API testing tools
     * Code quality tools

3. Core Feature Development:
   For each feature mentioned in the project description:
   - Create setup tasks
   - List database model creation tasks
   - Include API endpoint development
   - Add service layer implementation
   - Include unit test creation
   - Add integration test tasks
   - Create documentation tasks

4. Frontend Development (if applicable):
   Based on UI/UX requirements:
   - Component structure setup
   - State management implementation
   - API integration tasks
   - Responsive design implementation
   - User interaction features
   - Component testing tasks
   - Browser compatibility testing

5. Testing & Quality Assurance:
   Create specific tasks for:
   - Unit testing each component
   - Integration testing
   - End-to-end testing
   - Performance testing
   - Security testing
   - Cross-browser testing
   - Mobile responsiveness testing

6. Deployment & Documentation:
   - Deployment preparation tasks
   - Server configuration
   - CI/CD pipeline setup
   - User documentation
   - API documentation
   - System architecture documentation
   - Maintenance guidelines

For each task, provide:
- Clear title describing the specific development step
- Detailed technical description including acceptance criteria
- Required technical skills
- Assigned team member based on expertise
- Estimated hours (within daily ${maxDailyHours}-hour limit)
- Priority level (High/Medium/Low)
- Technical dependencies and prerequisites
- Expected deliverables
- Cost calculation based on member's hourly rate

Task Organization Rules:
1. Group related tasks together
2. Order tasks based on dependencies
3. Consider skill requirements for assignments
4. Balance workload across team members
5. Ensure knowledge sharing opportunities
6. Maximum ${maxDailyHours} hours per person per day
7. Include buffer time for unexpected issues
8. Account for code review and testing time

Please create a detailed development plan that:
- Is specifically tailored to the project description
- Includes all necessary technical tasks
- Follows best practices for the required technologies
- Ensures proper testing and documentation
- Maintains clear technical dependencies
- Provides accurate time and cost estimates
- Considers team member expertise for assignments`,
                responseType: {
                    format: 'json',
                    structure: {
                        projectPlan: {
                            summary: 'string',
                            estimatedDuration: {
                                totalWeeks: 'number',
                                startDate: 'string',
                                endDate: 'string',
                                reasoning: 'string'
                            },
                            timeline: {
                                weeks: [{
                                    weekNumber: 'number',
                                    weekSummary: 'string',
                                    days: [{
                                        date: 'string',
                                        dayOfWeek: 'string',
                                        tasks: [{
                                            id: 'string',
                                            title: 'string',
                                            description: 'string',
                                            technicalRequirements: ['string'],
                                            assignedTo: 'string',
                                            estimatedHours: 'number',
                                            priority: 'string',
                                            complexity: 'string',
                                            dependencies: ['string'],
                                            deliverables: ['string'],
                                            acceptanceCriteria: ['string'],
                                            cost: {
                                                original: {
                                                    amount: 'number',
                                                    currency: 'string'
                                                },
                                                usd: {
                                                    amount: 'number',
                                                    currency: 'USD'
                                                }
                                            }
                                        }],
                                        dailyTotal: {
                                            hours: 'number',
                                            costs: [{
                                                amount: 'number',
                                                currency: 'string'
                                            }]
                                        }
                                    }],
                                    weeklyTotal: {
                                        hours: 'number',
                                        costs: [{
                                            amount: 'number',
                                            currency: 'string'
                                        }],
                                        completionPercentage: 'number'
                                    }
                                }]
                            },
                            costs: {
                                totalProjectCost: {
                                    amount: 'number',
                                    currency: 'string'
                                },
                                weeklyAverage: {
                                    amount: 'number',
                                    currency: 'string'
                                },
                                costBreakdown: {
                                    byTeamMember: [{
                                        name: 'string',
                                        totalHours: 'number',
                                        totalCost: {
                                            original: {
                                                amount: 'number',
                                                currency: 'string'
                                            },
                                            usd: {
                                                amount: 'number',
                                                currency: 'USD'
                                            }
                                        }
                                    }]
                                }
                            },
                            recommendations: ['string']
                        }
                    }
                },
                lang: projectLanguage
            });

            // Make API request
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.timeout = 180000; // 3 minutes timeout

            xhr.addEventListener('readystatechange', function () {
                if (this.readyState === this.DONE) {
                    try {
                        if (this.status === 502) {
                            resultsDiv.innerHTML = '<div class="alert alert-error">Server is temporarily unavailable. Please try again in a few moments.</div>';
                            return;
                        }
                        
                        const response = JSON.parse(this.responseText);
                        if (response.result && response.result.response) {
                            window.projectPlanData = response.result.response.projectPlan;
                            displayResults(window.projectPlanData);
                            updateUrlHash();
                        } else {
                            resultsDiv.innerHTML = '<div class="alert alert-error">Invalid response from API. Please try again.</div>';
                        }
                    } catch (e) {
                        console.error('Error parsing API response:', e);
                        resultsDiv.innerHTML = '<div class="alert alert-error">Error communicating with the API. Please try again.</div>';
                    }
                }
            });

            xhr.addEventListener('timeout', function() {
                resultsDiv.innerHTML = '<div class="alert alert-error">Request timed out after 3 minutes. Please try again.</div>';
            });

            xhr.addEventListener('error', function() {
                resultsDiv.innerHTML = '<div class="alert alert-error">Network error occurred. Please check your connection and try again.</div>';
            });

            xhr.open('POST', 'https://generative-ai-api-openai-gpt-4o-api-ai-integration.p.rapidapi.com/generate?noqueue=1');
            xhr.setRequestHeader('x-rapidapi-key', apiKey);
            xhr.setRequestHeader('x-rapidapi-host', 'generative-ai-api-openai-gpt-4o-api-ai-integration.p.rapidapi.com');
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.send(data);
        }

        function addNewWeek() {
            if (!window.projectPlanData.timeline) {
                window.projectPlanData.timeline = {
                    weeks: []
                };
            }

            const newWeek = {
                weekNumber: window.projectPlanData.timeline.weeks.length + 1,
                days: Array.from({ length: 7 }, (_, i) => ({
                    date: `Day ${i + 1}`,
                    tasks: []
                }))
            };

            window.projectPlanData.timeline.weeks.push(newWeek);
            displayResults(window.projectPlanData);
            updateUrlHash();
        }

        function addNewTask(weekIndex, dayIndex) {
            if (!window.projectPlanData.timeline) {
                addNewWeek();
            }

            const newTask = {
                id: `task-${Date.now()}`,
                title: '',
                description: '',
                assignedTo: '',
                estimatedHours: 0
            };

            window.projectPlanData.timeline.weeks[weekIndex].days[dayIndex].tasks.push(newTask);
            displayResults(window.projectPlanData);
            updateUrlHash();
        }

        function deleteTask(weekIndex, dayIndex, taskIndex) {
            window.projectPlanData.timeline.weeks[weekIndex].days[dayIndex].tasks.splice(taskIndex, 1);
            displayResults(window.projectPlanData);
            updateUrlHash();
        }

        function deleteWeek(weekIndex) {
            window.projectPlanData.timeline.weeks.splice(weekIndex, 1);
            window.projectPlanData.timeline.weeks.forEach((week, index) => {
                week.weekNumber = index + 1;
            });
            displayResults(window.projectPlanData);
            updateUrlHash();
        }

        function updateTaskTitle(taskId, newTitle) {
            const task = findTask(taskId);
            if (task) {
                task.title = newTitle;
                updateUrlHash();
            }
        }

        function updateTaskDescription(taskId, newDescription) {
            const task = findTask(taskId);
            if (task) {
                task.description = newDescription;
                updateUrlHash();
            }
        }

        function updateTaskAssignee(taskId, newAssignee) {
            const task = findTask(taskId);
            if (task) {
                task.assignedTo = newAssignee;
                // Recalculate costs and update display
                calculateAndDisplayCost(task);
                displayResults(window.projectPlanData);
                updateUrlHash();
            }
        }

        function updateTaskHours(taskId, newHours) {
            const task = findTask(taskId);
            if (task) {
                task.estimatedHours = parseFloat(newHours);
                // Recalculate costs and update display
                calculateAndDisplayCost(task);
                displayResults(window.projectPlanData);
                updateUrlHash();
            }
        }

        function findTask(taskId) {
            if (!window.projectPlanData) return null;
            
            for (const week of window.projectPlanData.timeline.weeks) {
                for (const day of week.days) {
                    const task = day.tasks.find(t => t.id === taskId);
                    if (task) return task;
                }
            }
            return null;
        }

        // Add initial team member field
        addTeamMember();

        // Update language function
        function updateLanguage() {
            const lang = document.getElementById('projectLanguage').value;
            document.documentElement.lang = lang;
            updateUrlHash();
        }

        // Update QR code generation function
        function updateQRCode() {
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = ''; // Clear previous QR code
            
            let currentUrl = window.location.href;
            
            // Check if URL is valid and has content
            if (!currentUrl || currentUrl === window.location.origin + window.location.pathname) {
                qrcodeDiv.innerHTML = '<div class="text-sm text-base-content/70 p-4">Configure settings</div>';
                return;
            }

            try {
                // Create canvas element
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 320;
                canvas.style.width = '320px';
                canvas.style.height = '320px';
                canvas.style.display = 'block';
                qrcodeDiv.appendChild(canvas);

                // Generate QR code
                const qr = new QRious({
                    element: canvas,
                    value: currentUrl,
                    size: 320,
                    level: 'L',
                    background: '#FFFFFF',
                    backgroundAlpha: 1,
                    foreground: '#000000',
                    foregroundAlpha: 1,
                    padding: null
                });

                // Adjust canvas style
                canvas.style.imageRendering = 'pixelated';
            } catch (error) {
                console.error('Error generating QR code:', error);
                qrcodeDiv.innerHTML = '<div class="text-sm text-error p-4">QR Code generation failed</div>';
            }
        }

        // Update URL hash function to include QR code update
        const originalUpdateUrlHash = updateUrlHash;
        updateUrlHash = function() {
            originalUpdateUrlHash();
            setTimeout(updateQRCode, 100); // Add a small delay to ensure hash is updated
        };

        // Update QR code on page load
        window.addEventListener('load', function() {
            setTimeout(updateQRCode, 100); // Add a small delay to ensure page is fully loaded
        });

        // Update QR code when hash changes
        window.addEventListener('hashchange', function() {
            setTimeout(updateQRCode, 100); // Add a small delay to ensure hash is updated
        });

        // Task management functions
        let projectPlanData = null;

        function getTeamMemberOptions(selectedMember) {
            const teamMembers = Array.from(document.querySelectorAll('#teamMembers .card'))
                .map(card => {
                    const nameInput = card.querySelector('input[placeholder="Team Member Name"]');
                    const name = nameInput.value.trim();
                    return name ? name : null;
                })
                .filter(name => name !== null && name !== '');
            
            return `
                <option value="">👤 Assign to</option>
                ${teamMembers.map(member => 
                    `<option value="${member}" ${member === selectedMember ? 'selected' : ''}>${member}</option>`
                ).join('')}
            `;
        }

        // Add event listener to update task assignees when team members change
        function addTeamMemberChangeListener(memberDiv) {
            const nameInput = memberDiv.querySelector('input[placeholder="Team Member Name"]');
            nameInput.addEventListener('input', () => {
                // Update all task assignee dropdowns
                document.querySelectorAll('select[onchange^="updateTaskAssignee"]').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = getTeamMemberOptions(currentValue);
                });
                updateUrlHash();
            });
        }

        function updateUrlHash() {
            const apiKey = document.getElementById('apiKey').value;
            const projectDescription = document.getElementById('projectDescription').value;
            const projectLanguage = document.getElementById('projectLanguage').value;
            const maxDailyHours = document.getElementById('maxDailyHours').value;
            
            const teamMembers = Array.from(document.querySelectorAll('#teamMembers .card')).map(card => ({
                name: card.querySelector('input[placeholder="Team Member Name"]').value,
                rate: card.querySelector('input[placeholder="0.00"]').value,
                currency: card.querySelector('select').value
            }));

            const hashData = {
                apiKey,
                projectDescription,
                projectLanguage,
                maxDailyHours,
                teamMembers,
                projectPlan: window.projectPlanData
            };

            window.location.hash = btoa(JSON.stringify(hashData));
            updateQRCode();
        }

        // Add maxDailyHours event listener
        document.getElementById('maxDailyHours').addEventListener('change', updateUrlHash);

        // Load data from URL hash on page load
        window.addEventListener('load', () => {
            try {
                if (window.location.hash) {
                    const decodedData = JSON.parse(atob(window.location.hash.substring(1)));
                    
                    // Set maxDailyHours if present
                    if (decodedData.maxDailyHours) {
                        document.getElementById('maxDailyHours').value = decodedData.maxDailyHours;
                    }
                    
                    // Set project plan if present
                    if (decodedData.projectPlan) {
                        window.projectPlanData = decodedData.projectPlan;
                        displayResults(window.projectPlanData);
                    }
                }
            } catch (error) {
                console.error('Error parsing URL data:', error);
            }
        });

        // Add change event listener for maxDailyHours
        document.getElementById('maxDailyHours').addEventListener('change', () => {
            updateUrlHash();
        });
    </script>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300/80 backdrop-blur-sm text-base-content fixed bottom-0 w-full border-t border-base-200">
        <div>
            <a href="https://linkedin.com/in/samet-utku-olgun/" target="_blank" class="btn btn-ghost gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                </svg>
                Connect on LinkedIn
            </a>
        </div>
    </footer>

    <!-- Add padding to main container to prevent content from being hidden by footer -->
    <style>
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
                padding-bottom: 5rem;
            }
        }
        .container {
            padding-bottom: 5rem;
        }
    </style>
</body>
</html>
